Video link - https://www.youtube.com/watch?v=yT3w2iig9MI&list=PLYrn63eEqAzYttcyB6On1oH35O5rxgDt4&index=10

Video Agenda:

00:00 Matrix Generator
00:39:21 Merge Generator

Video Lab repo - https://github.com/devopshobbies/argocd-tutorial

Notes Lab repo - https://github.com/entermix123/ArgoCD-Labs

Killercoda exercise platform - https://killercoda.com/mabusaa/course/argocd-endusers-scenarios



Prerequisites
=============

1. We should have installed and running ArgoCD on one of our clusters.
----------------------------------------------------------------------

We can find cluster and ArgoCD installation instruction in section "02 - Setting-up ArgoCD" and "08 - adding cluster & tracking strategies".


2. Login to ArgoCD CLI:
-----------------------

Find the password of admin user of ArgoCD
	powershell terminal --> k -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | ForEach-Object { [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($_)) }

	# result: password


Connect to the Node with ArgoCD CLI
	terminal --> argocd login localhost:32074 --insecure --grpc-web --username admin --password Tip-kdHFNljqdnq3
	or
	terminal --> argocd login localhost:32074 --insecure --grpc-web --username admin
	terminal --> password


3. We should have 2 running and connected to ArgoCD clusters:
-------------------------------------------------------------

List clusters
	terminal --> argocd cluster list

	# result:
	SERVER                               NAME      VERSION  STATUS      MESSAGE  PROJECT
	https://cluster2-control-plane:6443  external  1.34     Successful
	https://kubernetes.default.svc       local     1.34     Successful






Matrix Generator
================

Matrix generator combines parameters generated by 2 child generators. This allow us to make every possible parameter combination.

We can combine parameters from different tools and deploy applications on different clusters
	- Jenkins
	- prometheus operator

We want to deploy Jenkins on both clusters and prometheus on bith clusters. This means that we will have 4 applications in total.
	- jenkins-in-local-cluster
	- jenkins-in-external-cluster
	- prometheus-in-local-cluster
	- prometheus-in-external-cluster


We will go over 3 example matrix generators.


EXAMPLE 1 - git & cluster child generator - deploy mutiple applications from source folder in repository on multiple clusters
---------

We will use mixed generator (git & cluster child generator) that will deploy 4 applications in total - 2 on every cluster


matrix-generator-ex1.yaml
-----------------------------------------------
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: matrix-generator-ex1
spec:
  generators:
    - matrix:                                                                         # matrix generator
        generators:                                                                   # list of generators
          - git:                                                                      # git generator
              repoURL: https://github.com/entermix123/ArgoCD-Labs                     # used repository
              revision: main                                                          # used branch as versioning
              directories:
                - path: 09-argocd-applicationSet-1/git-generator/resources/*          # applications source folder path 
          - clusters: {}                                                              # cluster child generator
  template:
    metadata:
      name: '{{path.basename}}-{{name}}'       # application name based on source fodler name and cluster name
    spec:
      project: default
      source:
        repoURL: https://github.com/entermix123/ArgoCD-Labs                           # used repository for application template
        targetRevision: main                                                          # used branch as versioning
        path: '{{path}}'                                                              # application source folder path
      destination:
        server: '{{server}}'                                                          # cluster url
        namespace: '{{metadata.labels.environment}}'                 # destination namespace based on cluster labels
      syncPolicy:
        automated: {}                                                                 # automated sync
        syncOptions:
          - CreateNamespace=true                                                      # automated namespace creation
-----------------------------------------------

We can check clusters tags in ArgoCDSettings/Clusters or printing the secrets we used to connect to the external cluster and to labelk the local cluster:
	List secrets
		terminal --> k get secrets

	Print the secrets to find labels added to each cluster
		terminal --> k describe secret local
		terminal --> k describe secret cluster-cluster2-control-plane-xxxxxxxxxxx	# autogenerated with terraform

		# in each secret there should be "Labels" section with all cluster labels


Apply the matrix generator manifest
	terminal --> k apply -f matrix-generator-ex1.yaml

	# result: applicationset.argoproj.io/matrix-generator-ex1 created

In ArgoCD UI that we have 4 applications:
	- local cluster
		- nginx-helm-local
		- nginx-manifests-local
	- external cluster
		- nginx-helm-external
		- nginx-manifests-external


Delete the applications
	terminal --> k delete -f matrix-generator-ex1.yaml

	# result: applicationset.argoproj.io "matrix-generator-ex1" deleted from argocd namespace


Delete namespaces from both clusters to keep them clean and fresh
	local cluster terminal --> k delete ns pre-staging

	# result: namespace "pre-staging" deleted

	List contexts
		terminal --> kubectl config get-contexts

		# result:
		CURRENT   NAME            CLUSTER         AUTHINFO        NAMESPACE
		          kind-cluster2   kind-cluster2   kind-cluster2			# next target context
        	*  	  kind-kind       kind-kind       kind-kind       argocd	


	Connect to external cluster
		terminal --> kubectl config use-context kind-cluster2

		# result: Switched to context "kind-cluster2"

	
	Delete "staging" namespace
		external cluster terminal --> k delete ns staging

		# result: namespace "staging" deleted


	Connect to local cluster again
		terminal --> kubectl config use-context kind-kind

		# result: Switched to context "kind-kind"








EXAMPLE 2 - git & list generator - deploy mutiple applications from source folder in repository on multiple clusters
---------


matrix-generator-ex2.yaml
-----------------------------------------------
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: matrix-generator-ex2
spec:
  generators:
    - matrix:                                                                             # matrix generator
        generators:                                                                       # list of generators
          - git:                                                                          # git generator
              repoURL: https://github.com/entermix123/ArgoCD-Labs                         # used repository by the generator
              revision: main                                                              # used branch as versioning
              directories:
                - path: 09-argocd-applicationSet-1/git-generator/resources/*              # applications source folder path
          - list:                                                                         # list generator
              elements:                                                                   # list of elements
              - environment: pre-staging                                                  # environment 1 name
                server: https://kubernetes.default.svc                                    # local cluster url
              - environment: staging                                                      # environment 2 name
                server: https://cluster2-control-plane:6443                               # external cluster url
  template:
    metadata:
      name: '{{path.basename}}-{{environment}}'                   # application name based on source fodler name and environment name 
    spec:
      project: default
      source:
        repoURL: https://github.com/entermix123/ArgoCD-Labs       # used repository for application template
        targetRevision: main                                      # used branch as versioning
        path: '{{path}}'                                          # application source folder path
      destination:
        server: '{{server}}'                                      # clusters urls
        namespace: '{{environment}}'                              # destination namespace based on environments names
      syncPolicy:
        automated: {}                                             # automated sync
        syncOptions:
          - CreateNamespace=true                                  # automated namespace creation
-----------------------------------------------


Apply the generator's manifest
	terminal --> k apply -f matrix-generator-ex2.yaml

	# result: applicationset.argoproj.io/matrix-generator-ex2 created

In ArgoCD UI we can see that we have deployed 4 applications again
	- local cluster
		- nginx-helm-pre-staging
		- nginx-manifests-pre-staging
	- external cluster
		- nginx-helm-staging
		- nginx-manifests-staging

We can also list resource in 'pre-staging' namespace on local cluster
	terminal --> k get all -n pre-staging


Delete the applications
	terminal --> k delete -f matrix-generator-ex2.yaml

	# result: applicationset.argoproj.io "matrix-generator-ex2" deleted from argocd namespace


Delete namespaces from both clusters to keep them clean and fresh
	local cluster terminal --> k delete ns pre-staging

	# result: namespace "pre-staging" deleted

	List contexts
		terminal --> kubectl config get-contexts

		# result:
		CURRENT   NAME            CLUSTER         AUTHINFO        NAMESPACE
		          kind-cluster2   kind-cluster2   kind-cluster2			# next target context
        	*  	  kind-kind       kind-kind       kind-kind       argocd	


	Connect to external cluster
		terminal --> kubectl config use-context kind-cluster2

		# result: Switched to context "kind-cluster2"

	
	Delete "staging" namespace
		external cluster terminal --> k delete ns staging

		# result: namespace "staging" deleted


	Connect to local cluster again
		terminal --> kubectl config use-context kind-kind

		# result: Switched to context "kind-kind"








EXAMPLE 3 - git & cluster generator - deploy mutiple applications from source folder in repository on multiple filtered clusters
---------

In this example we will use git and cluster generators. Cluster generator will be configured with cluster configuration files and matching labels filter.

This apprach allows us to deploy specific applications to specifiv clusters.

We have used cluster confguration files in the previous section - 09 - AgroCD applicationSet Part-1:

pre-staging config.json
-----------------------------------------------
{
    "cluster": {
      "owner": "jordan",
      "name": "pre-staging",
      "path": "argocd-application/directoryOfmanifests",
      "source_type": "directoryOfManifests",
      "address": "https://kubernetes.default.svc",
      "namespace": "pre-staging-ns"
    }
  }

-----------------------------------------------


staging config.json
-----------------------------------------------
{
    "cluster": {
      "owner": "jordan",
      "name": "staging",
      "path": "argocd-application/helm-charts/nginx",
      "source_type": "helm", 
      "address": "https://cluster2-control-plane:6443",
      "namespace": "staging-ns"
    }
  }

-----------------------------------------------



Based on the values in the cluster configurations above we set matrix generator. This apprach allows us to deploy specific applications to specifiv clusters.


matrix-generator-ex3.yaml
-----------------------------------------------
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: matrix-generator-ex3
spec:
  generators:
    - matrix:                                                                                       # matrix generator
        generators:                                                                                 # list of generators
          - git:                                                                                    # git generator
              repoURL: https://github.com/entermix123/ArgoCD-Labs                                   # used repository
              revision: main                                                                        # used branch as versioning
              files:
                - path: 09-argocd-applicationSet-1/git-generator/cluster-config/**/config.json # cluster configurations files path
          - clusters:                                                                               # cluster generator
              selector:                                                                             # cluster selector
                matchLabels:
                  argocd.argoproj.io/secret-type: cluster                      # cluster match label filter 1
                  environment: '{{cluster.name}}'                              # cluster match label filter 2 - envronment label
  template:
    metadata:
      name: '{{name}}-application'                                      # application name
    spec:
      project: default
      source:
        repoURL: https://github.com/entermix123/ArgoCD-Labs             # used repository
        targetRevision: main                                            # used branch as versioning
        path: '{{cluster.path}}'                                        # application source folder path
      destination:
        server: '{{server}}'                                            # clusters urls from the cluster configs
        namespace: '{{metadata.labels.environment}}'                    # destination namespace name based on cluster labels
      syncPolicy:
        automated: {}                                                   # automated sync
        syncOptions:
          - CreateNamespace=true                                        # automated namespace creation
-----------------------------------------------


Apply the generator manifest
	terminal --> k apply -f matrix-generator-ex3.yaml

	# result: applicationset.argoproj.io/matrix-generator-ex3 created

In ArgoCD UI we can see that only 2 applications are deployed because of the labels filtering.
	- local cluster
		- local-application
	- external cluster
		- external-application

We can list resources in pre-staging namespace in the local cluster 
	terminal --> k get all -n pre-staging

	# result:
	NAME                         READY   STATUS    RESTARTS   AGE
	pod/nginx-7cfc547459-wmkgg   1/1     Running   0          2m9s

	NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
	service/nginx   ClusterIP   10.96.227.224   <none>        80/TCP    2m9s

	NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
	deployment.apps/nginx   1/1     1            1           2m9s

	NAME                               DESIRED   CURRENT   READY   AGE
	replicaset.apps/nginx-7cfc547459   1         1         1       2m9s


Delete the applications 
	terminal --> k delete -f matrix-generator-ex3.yaml

	# result: applicationset.argoproj.io "matrix-generator-ex3" deleted from argocd namespace


Delete namespaces from both clusters to keep them clean and fresh
	local cluster terminal --> k delete ns pre-staging

	# result: namespace "pre-staging" deleted

	List contexts
		terminal --> kubectl config get-contexts

		# result:
		CURRENT   NAME            CLUSTER         AUTHINFO        NAMESPACE
		          kind-cluster2   kind-cluster2   kind-cluster2			# next target context
        	*  	  kind-kind       kind-kind       kind-kind       argocd	


	Connect to external cluster
		terminal --> kubectl config use-context kind-cluster2

		# result: Switched to context "kind-cluster2"


	Delete "staging" namespace
		external cluster terminal --> k delete ns staging

		# result: namespace "staging" deleted


	Connect to local cluster again
		terminal --> kubectl config use-context kind-kind

		# result: Switched to context "kind-kind"











Merge Generator
===============

Merge generators conbines parameters produced by the first (base) generator with matching parameters sets produced by subsequent generators.

Using a merge generator is appropriate when a subset of parameter sets require overwriting.

We will deploy application on 2 clusters
	- local cluster
	- external cluster

In this example we will overwrite 'replicaCount' and image tag of the helm chart of nginx located in 'argocd-application/helm-charts/nginx/values.yaml':

-----------------------------------------------
# Default values for nginx.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# This will set the replicaset count more information can be found here: https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/
replicaCount: 2									# target parameter

# This sets the container image more information can be found here: https://kubernetes.io/docs/concepts/containers/images/
image:
  repository: nginx
  # This sets the pull policy for images.
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""									# target parameter
...
-----------------------------------------------


We will configure 3 generators and their produced key-values pairs
	- base cluster generator
		- tag: 1.23			# image tag of nginx
		- replicas: 1			# replicas of nginx

	- overwride cluster generator		# overwrite only tag value for specific cluster (external)
		- matchSelector
		  environment: staging		# filter cluster to overwrite key-values tag with this label
		- values
		  tag: 1.24			# overwrite image tag to 1.24
	- list generator
		- elements
		  server: https://kubernetes.default.svc	# cluster url
		    values.replicas: 3				# overwrite replicaCount from 1 to 3 on local cluster

On the local cluster wi will have 3 replicas and image tag 1.23, beacause local cluster  don't have tag 'envronment: staging'.
On the external cluster we will have 1 replica and image tag 1.24 because external cluster has a label 'envronment: staging'.


merge-generator-ex1.yaml
-----------------------------------------------
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: merge-generator-ex1
spec:
  generators:                                                 # generators merge configuration
    - merge:
        mergeKeys:                                            # merge keys
          - server                                            # allows to combine outputs from all generators in one output
        generators:                                           # list of generators
          - clusters:                                         # base generator
              values:                                         # default values
                tag: '1.23'                                   # sepcify image tag parameter in 'values.yaml'
                replicas: '1'                                 # specify replicas parameter in 'values.yaml'
          - clusters:                                         # overwrite generator 1
              selector:                                       # cluster selector
                matchLabels:                                  # cluster match label filter
                  environment: 'staging'                      # select cluster with 'staging' label - external cluster
              values:                                         # overwrite values
                tag: '1.24'                                   # overwrite image tag to 1.24
          - list:                                             # overwrite generator 2
              elements:                                       # list of elements (clusters)
                - server: https://kubernetes.default.svc      # target cluster url - local cluster
                  values.replicas: '3'                        # overwrite replicas to 3
  template:
    metadata:
      name: '{{name}}-application'                              # application name based on the cluster name
    spec:
      project: default
      source:
        repoURL: https://github.com/entermix123/ArgoCD-Labs     # used repository
        targetRevision: main                                    # used branch as versioning
        path: argocd-application/helm-charts/nginx              # application source folder path
        helm:
          parameters:                                           # helm parameters
            - name: "image.tag"                                 # target parameter 1
              value: '{{values.tag}}'                           # replace parameter value with generated value from cluster generator
            - name: "replicaCount"                              # target parameter 2
              value: '{{values.replicas}}'                      # replace parameter value with generated value from list generator
      destination:
        server: '{{server}}'                                    # cluster url
        namespace: '{{metadata.labels.environment}}'            # destination namespace name based on cluster environment labels
      syncPolicy:
        automated: {}                                           # automated sync
        syncOptions:
          - CreateNamespace=true                                # automated namespace creation
-----------------------------------------------

Apply the manifest
	terminal --> k apply -f merge-generator-ex1.yaml

	# result: applicationset.argoproj.io/merge-generator-ex1 created

In ArgoCD UI that 2 applications are created.
	- external-application - in application details we have 1 replica and image tag: 1.24
	- local-application - in application details we have 3 replicas and image tag: 1.23


Delete the applications
	terminal --> k delete -f merge-generator-ex1.yaml

	# result: applicationset.argoproj.io "merge-generator-ex1" deleted from argocd namespace


Delete namespaces from both clusters to keep them clean and fresh
	local cluster terminal --> k delete ns pre-staging

	# result: namespace "pre-staging" deleted

	List contexts
		terminal --> kubectl config get-contexts

		# result:
		CURRENT   NAME            CLUSTER         AUTHINFO        NAMESPACE
		          kind-cluster2   kind-cluster2   kind-cluster2			# next target context
        	*  	  kind-kind       kind-kind       kind-kind       argocd	


	Connect to external cluster
		terminal --> kubectl config use-context kind-cluster2

		# result: Switched to context "kind-cluster2"


	Delete "staging" namespace
		external cluster terminal --> k delete ns staging

		# result: namespace "staging" deleted


	Connect to local cluster again
		terminal --> kubectl config use-context kind-kind

		# result: Switched to context "kind-kind"


























