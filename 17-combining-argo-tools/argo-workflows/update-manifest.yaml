apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: update-manifest-wf-template
spec:
  templates:
    - name: update-manifest
      inputs:
        parameters:                     # set parameters
          - name: github-username
          - name: github-token
          - name: nexus-registry
          - name: branch
        artifacts:
        - name: source
          path: /tmp/source
      script:
        image: alpine/git
        workingDir: /tmp/source/17-combining-argo-tools/argo-rollouts           # set manifests dir as working dir
        command: [sh]
        source: |
          sed -i 's|image:.*|image: {{inputs.parameters.nexus-registry}}/nginx:{{workflow.uid}}|' nginx-rollouts.yml
          git config user.name "{{inputs.parameters.github-username}}"
          git config user.email "{{inputs.parameters.github-username}}@users.noreply.github.com"
          git remote set-url origin https://{{inputs.parameters.github-username}}:{{inputs.parameters.github-token}}@github.com/entermix123/ArgoCD-Labs.git
          git add .
          git commit -m "image.tag has been changed to {{workflow.uid}}"
          git push origin {{inputs.parameters.branch}}