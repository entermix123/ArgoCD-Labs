apiVersion: argoproj.io/v1alpha1
kind: Workflow                       # manifest type
metadata:
  generateName: argo-demo-   # name of the manifest generated by the controller with random suffix
  # Each time the workflow is submitted it will get a new unique name
spec:
  arguments:
    parameters:
      - name: repo-url
        value: https://github.com/entermix123/ArgoCD-Labs.git
        # we need to provide username and token to argo workflows to access the repository and update the manifest
      - name: branch                                  # version type, can be commit, tag, branch
        value: main                                   # branch name
      - name: nexus-registry                          # registry name
        value: host.docker.internal:8085              # url of the nexus repository
      - name: github-username                    # use github username from secret
        valueFrom:
          secretKeyRef:
            name: github-credentials             # secret name
            key: username                        # secret key
      - name: github-token                       # use github token from secret
        valueFrom:
          secretKeyRef:
            name: github-credentials             # secret name
            key: token                           # secret key
  artifactRepositoryRef:
    configMap: artifact-repository                    # reference of the configmap
  entrypoint: ci                                      # entrypoint
  templates:
  - name: ci                                          # we use dag type template invoker to execute other workflow templates
    dag:
      tasks:
      - name: clone-repo-task                            # task name
        templateRef:
          name: clone-repo-wf-template                   # name of the workflow template
          template: clone-repo                           # name of the manifest of the workflow template
      - name: build-push-task                            # task name
        templateRef:
          name: build-push-wf-template                   # name of the workflow template
          template: build-and-push                       # name of the manifest of the workflow template
        arguments:
          artifacts:                                                        # artifacts section
            - name: source                                                  # artifact name
              from: "{{tasks.clone-repo-task.outputs.artifacts.source}}"    # artifact source - the output of the previous task
        dependencies: [clone-repo-task]                                     # depends of the previous task success or failure
      - name: update-manifest-task                       # task name
        templateRef:
          name: update-manifest-wf-template              # name of the workflow template
          template: update-manifest                      # name of the manifest of the workflow template
        arguments:
          parameters:                                    # Pass the GitHub creadentials to the third task
            - name: github-username
              value: "{{workflow.parameters.github-username}}"
            - name: github-token
              value: "{{workflow.parameters.github-token}}"
            - name: nexus-registry
              value: "{{workflow.parameters.nexus-registry}}"
            - name: branch
              value: "{{workflow.parameters.branch}}"
          artifacts:                                                        # artifacts section
            - name: source                                                  # artifact name
              from: "{{tasks.clone-repo-task.outputs.artifacts.source}}"    # artifact source - the output of the first task
        dependencies: [clone-repo-task, build-push-task]                    # depends of the first and second tasks success or failure
